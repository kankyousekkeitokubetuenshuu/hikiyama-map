<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Hikiyama Map (Overlay Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e5e5;
      border-radius: 16px;
      padding: 14px 14px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.12);
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      width: 260px;
    }

    .row {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
      margin: 10px 0;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 15px;
      outline: none;
    }

    .opacityLine{
      display: flex;
      align-items: baseline;
      justify-content: flex-start;
      gap: 8px;
      font-size: 16px;
      font-weight: 700;
    }
    .opacityLine .val{
      font-variant-numeric: tabular-nums;
      opacity: 0.95;
    }

    input[type="range"]{
      width: 100%;
      margin: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel" id="panel">
    <div class="row" style="margin-top:0;">
      <select id="layerSelect"></select>
    </div>

    <div class="row">
      <div class="opacityLine">
        <span>透明度</span>
        <span class="val" id="opacityVal">0.70</span>
      </div>
      <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.70" />
    </div>
  </div>

  <script>
    // レイヤー名と並び順（指定どおり）
    const LAYER_CONFIG = [
      { key: "wafuu",  name: "和風のみ",  url: "images/wafuu_overlay.png" },
      { key: "kawara", name: "瓦のみ",    url: "images/kawara_overlay.png" },
      { key: "both",   name: "瓦&和風",   url: "images/both_overlay.png" },
      { key: "none",   name: "遵守なし",  url: "images/none_overlay.png" },
      { key: "road",   name: "曳山通り",  url: "images/road_overlay.png" },
    ];

    // 左下(southWest) と 右上(northEast)
    const OVERLAY_BOUNDS = [
      [33.443267473, 129.960596615], // southWest
      [33.456098806, 129.981188012], // northEast
    ];

    const MIN_ZOOM = 15;
    const MAX_ZOOM = 21;

    const map = L.map('map', { minZoom: MIN_ZOOM, maxZoom: MAX_ZOOM, zoomControl: true });

    // ベース地図は常にON
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    osm.addTo(map);

    const overlays = new Map();
    let currentKey = null;

    function ensureOverlay(key) {
      if (overlays.has(key)) return overlays.get(key);
      const cfg = LAYER_CONFIG.find(x => x.key === key);
      if (!cfg) return null;

      const ov = L.imageOverlay(cfg.url, OVERLAY_BOUNDS, {
        opacity: parseFloat(document.getElementById('opacity').value || "0.7"),
        interactive: false
      });

      // 読み込み失敗が分かるようにログ
      ov.on('error', () => console.error("PNG読み込み失敗:", cfg.url));

      overlays.set(key, ov);
      return ov;
    }

    function showOverlay(key) {
      if (currentKey && overlays.has(currentKey)) map.removeLayer(overlays.get(currentKey));
      currentKey = key;

      const ov = ensureOverlay(key);
      if (!ov) return;

      ov.setOpacity(parseFloat(document.getElementById('opacity').value || "0.7"));
      ov.addTo(map);
      map.fitBounds(OVERLAY_BOUNDS);
    }

    const sel = document.getElementById('layerSelect');
    LAYER_CONFIG.forEach(cfg => {
      const opt = document.createElement('option');
      opt.value = cfg.key;
      opt.textContent = cfg.name;
      sel.appendChild(opt);
    });

    // 初期表示
    sel.value = LAYER_CONFIG[0].key;
    showOverlay(sel.value);

    sel.addEventListener('change', () => showOverlay(sel.value));

    const opacity = document.getElementById('opacity');
    const opacityVal = document.getElementById('opacityVal');
    opacity.addEventListener('input', () => {
      const v = parseFloat(opacity.value);
      opacityVal.textContent = v.toFixed(2);
      if (currentKey && overlays.has(currentKey)) overlays.get(currentKey).setOpacity(v);
    });
  </script>
</body>
</html>
